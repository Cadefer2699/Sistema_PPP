{% extends "/ppp/home.html" %}
{% block titulo %} Prácticas Terminadas del Mes {% endblock %}
{% block contenido %}
<nav style="--bs-breadcrumb-divider: '>'" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('router_main.index') }}">Inicio</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('router_main.practicas_pre_profesionales') }}">Módulo de Prácticas Pre Profesionales</a></li>
        <li class="breadcrumb-item active" aria-current="page">Prácticas Terminadas del Mes</li>
    </ol>
</nav>

<div class="container-fluid my-4">
    <div class="card w-100">
        <div class="card-header bg-red-usat text-white">
            Alumnos que Completaron sus Prácticas
        </div>
        <div class="card-body">
            <!-- Selector de mes y año -->
            <div class="row mb-4">
                <div class="col-md-4 mx-auto">
                    <div class="input-group">
                        <select class="form-select" id="mes_selector">
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                        <select class="form-select" id="anio_selector">
                            <!-- Se llenará dinámicamente con JavaScript -->
                        </select>
                        <button class="btn btn-primary" id="btn_filtrar">
                            <i class="fas fa-filter"></i> Filtrar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Card con el total -->
            <div class="row mb-4">
                <div class="col-md-4 mx-auto">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title text-white">Total de Alumnos que Completaron</h5>
                            <h2 class="card-text" id="total_completados">0</h2>
                            <p class="card-text" id="mes_actual"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de alumnos -->
            <div class="table-responsive">
                <table id="tabla-practicas-terminadas" class="table table-striped" style="width:100%">
                    <thead>
                        <tr>
                            <th style="text-align:center">Nombre</th>
                            <th style="text-align:center">Apellidos</th>
                            <th style="text-align:center">Escuela</th>
                            <th style="text-align:center">Estado</th>
                            <th style="text-align:center">Acciones</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para detalles -->
<div class="modal fade" id="detallesModal" tabindex="-1" aria-labelledby="detallesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-red-usat text-white">
                <h5 class="modal-title" id="detallesModalLabel">Detalles de la Práctica</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Código:</strong> <span id="modal_codigo"></span></p>
                        <p><strong>Semestre:</strong> <span id="modal_semestre"></span></p>
                        <p><strong>Institución:</strong> <span id="modal_institucion"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Fecha Inicio:</strong> <span id="modal_fecha_inicio"></span></p>
                        <p><strong>Fecha Fin:</strong> <span id="modal_fecha_fin"></span></p>
                        <p><strong>Horas Completadas:</strong> <span id="modal_horas"></span></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Llenar selector de años (desde 2020 hasta el año actual)
        const anioActual = new Date().getFullYear();
        const anioSelector = $('#anio_selector');
        for (let anio = anioActual; anio >= 2020; anio--) {
            anioSelector.append(new Option(anio, anio));
        }

        // Establecer mes y año actual en los selectores
        const fecha = new Date();
        $('#mes_selector').val(fecha.getMonth() + 1);
        $('#anio_selector').val(fecha.getFullYear());

        // Función para actualizar la tabla
        function actualizarTabla() {
            const mes = $('#mes_selector').val();
            const anio = $('#anio_selector').val();
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            $('#mes_actual').text(meses[mes - 1] + ' ' + anio);

            if ($.fn.DataTable.isDataTable('#tabla-practicas-terminadas')) {
                $('#tabla-practicas-terminadas').DataTable().destroy();
            }

            $('#tabla-practicas-terminadas').DataTable({
                paging: true,
                info: true,
                responsive: true,
                autoWidth: false,
                searching: true,
                order: [[1, 'asc']],
                ajax: {
                    url: "/datos_practicas_terminadas",
                    type: "GET",
                    data: {
                        mes: mes,
                        anio: anio
                    },
                    dataSrc: function(json) {
                        $('#total_completados').text(json.length);
                        return json;
                    }
                },
                columns: [
                    { data: "Nombre_Alumno", className: 'text-center' },
                    { data: "Apellidos_Alumno", className: 'text-center' },
                    { data: "Escuela", className: 'text-center' },
                    { 
                        data: "Estado_Practica",
                        className: 'text-center',
                        render: function(data) {
                            return '<span class="badge bg-success">Completado</span>';
                        }
                    },
                    { 
                        data: null,
                        className: 'text-center',
                        render: function(data, type, row) {
                            return '<button class="btn btn-sm btn-info ver-detalles" data-bs-toggle="tooltip" title="Ver detalles">' +
                                   '<i class="fas fa-eye"></i></button>';
                        }
                    }
                ],
                language: {
                    url: "{{ url_for('static', filename='js/es-ES.json') }}",
                    searchPlaceholder: "Buscar...",
                    search: ""
                },
                dom: '<"top"lf>rt<"bottom"ip><"clear">',
                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Todos"]],
                pageLength: 10
            });
        }

        // Evento click del botón filtrar
        $('#btn_filtrar').click(function() {
            actualizarTabla();
        });

        // Manejador para el botón de detalles
        $('#tabla-practicas-terminadas').on('click', '.ver-detalles', function() {
            var table = $('#tabla-practicas-terminadas').DataTable();
            var data = table.row($(this).parents('tr')).data();
            
            // Llenar el modal con los datos
            $('#modal_codigo').text(data.Codigo_Universitario);
            $('#modal_semestre').text(data.Semestre_Academico);
            $('#modal_institucion').text(data.Institucion);
            $('#modal_fecha_inicio').text(new Date(data.Fecha_Inicio).toLocaleDateString('es-ES'));
            $('#modal_fecha_fin').text(new Date(data.Fecha_Fin).toLocaleDateString('es-ES'));
            $('#modal_horas').text(data.Horas_Completadas);
            
            // Mostrar el modal
            var detallesModal = new bootstrap.Modal(document.getElementById('detallesModal'));
            detallesModal.show();
        });

        // Inicializar tooltips
        $('[data-bs-toggle="tooltip"]').tooltip();

        // Inicializar tabla con el mes actual
        actualizarTabla();
    });
</script>
{% endblock %}
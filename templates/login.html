<!doctype html>
<html lang="es">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="{{ url_for('static', filename='dashboard/img/icons/usat_logo_red.jpg') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='login/fonts/icomoon/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='login/css/owl.carousel.min.css') }}">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='login/css/style.css') }}">

    <title>USAT - Iniciar Sesión</title>
    <style>
        /* Styles omitted for brevity */
    </style>
</head>

<body>

    <div id="carouselExampleIndicators" class="carousel slide half" data-ride="carousel">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img class="d-block w-100" src="{{ url_for('static', filename='login/images/campus.png') }}" alt="Campus 1">
            </div>
            <!-- Other carousel items omitted for brevity -->
        </div>
        <div class="contents">
            <div class="container">
                <div class="row align-items-center justify-content-center">
                    <div class="col-md-10">
                        <div class="text-center mb-3 form-block">
                            <img src="{{ url_for('static', filename='login/images/usat_logo.png') }}" alt="logoescuela" style="max-width: 180px;">
                            <br>
                            <h3>Bienvenido</h3>
                            <p>Ingrese sus credenciales para acceder al sistema</p>
                            <form action="" method="post">
                                <div class="form-group first">
                                    <span class="form-control-icon"></span>
                                    <input type="text" class="form-control" placeholder=" " id="username" name="username" style="padding-left: 25px;">
                                    <label class="form-control-label" for="username"><i class="fas fa-user"></i> Usuario</label>
                                </div>
                                <div class="form-group last mb-3">
                                    <span class="form-control-icon"></span>
                                    <input type="password" class="form-control" placeholder=" " id="password" name="password" style="padding-left: 25px;">
                                    <label class="form-control-label" for="password"><i class="fas fa-lock"></i> Contraseña</label>
                                </div>

                                <div class="d-flex mb-4 align-items-center">
                                    <label class="control control--checkbox mb-0"><span class="caption">Recordar</span>
                                        <input type="checkbox" checked="checked" id="recordar_check" name="recordar_check">
                                        <div class="control__indicator"></div>
                                    </label>
                                </div>

                                <button id="loginButton" class="btn btn-primary btn-lg btn-block mt-4" type="button" onclick="procesar_login()">
                                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    <span class="check-icon d-none">✔️</span>
                                    <strong>Acceder al Sistema</strong>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="{{ url_for('static', filename='login/js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='login/libs/sweetalert2/sweetalert2.js') }}"></script>

    <script>
        function hideBgOnMobile() {
            var screenWidth = window.innerWidth;
            var username = localStorage.getItem('username');
            var token = localStorage.getItem('token');

            if (!username || !token) {
                username = sessionStorage.getItem('username');
                token = sessionStorage.getItem('token');
            }

            if (username && token) {
                window.location.href = "{{ url_for('router_main.login') }}";  // Cambiado aquí
            }
        }

        window.onload = hideBgOnMobile;
        window.onresize = hideBgOnMobile;

        $(document).ready(function () {
            $('#carouselExampleIndicators').carousel({
                interval: 2000
            });
        });

        function mostrarAlerta(icon, title, text) {
            Swal.fire({
                icon: icon,
                title: title,
                text: text
            });
        }

        $('#btnLogin').click(function () {
            var username = $('#username').val();
            var password = $('#password').val();
            var recordar = $('#recordar_check').prop('checked');
            try {
                $.ajax({
                    url: '/login1',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        username: username,
                        password: password,
                    }),
                    success: function (response) {
                        console.log(response);
                        if (response.success) {
                            mostrarAlerta("success", "OK", response.success);
                            window.location.href = "{{ url_for('router_main.login') }}";  // Cambiado aquí
                        } else if (response.error) {
                            mostrarAlerta("error", "Error al Iniciar Sesión", response.error);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log(error);
                        mostrarAlerta("error", "Error en la Procesamiento de Solicitud", error);
                    }
                });
            } catch (e) {
                mostrarAlerta("error", "Error en AJAX", error.responseText);
            }
        });

        function procesar_login() {
            var username = document.getElementById("username").value;
            var password = document.getElementById("password").value;
            var recordar = document.getElementById("recordar_check").checked;

            if (username.trim() == "" || password.trim() == "") {
                if (username.trim() == "" && password.trim() == "") {
                    mostrarAlerta("warning", "No se pudo acceder al sistema", "Por favor ingrese un nombre de usuario y contraseña");
                } else if (username.trim() == "") {
                    mostrarAlerta("warning", "No se pudo acceder al sistema", "Por favor ingrese un nombre de usuario");
                } else if (password.trim() == "") {
                    mostrarAlerta("warning", "No se pudo acceder al sistema", "Por favor ingrese una contraseña");
                }
            } else {
                document.getElementById("loginButton").disabled = true;
                document.querySelector("#loginButton .spinner-border").classList.remove("d-none");
                fetch('/procesar_login', {
                    method: 'POST',
                    headers: {
                        'Content-type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.logeo) {
                            if (recordar) {
                                localStorage.setItem('username', username)
                                localStorage.setItem('token', data.token)
                                localStorage.setItem('n', data.nombre)
                                localStorage.setItem('f', data.foto)
                            } else {
                                sessionStorage.setItem('username', username)
                                sessionStorage.setItem('token', data.token)
                                sessionStorage.setItem('n', data.nombre)
                                sessionStorage.setItem('f', data.foto)
                            }
                            document.getElementById("loginButton").disabled = false;
                            document.querySelector("#loginButton .spinner-border").classList.add("d-none");
                            document.querySelector("#loginButton .check-icon").classList.remove("d-none");
                            document.querySelector("#loginButton strong").textContent = "Acceso Exitoso";
                            setTimeout(() => {
                                window.location.href = "{{ url_for('router_main.login') }}";  // Cambiado aquí
                            }, 1000);
                        } else {
                            document.getElementById("loginButton").disabled = false;
                            document.querySelector("#loginButton .spinner-border").classList.add("d-none");
                            mostrarAlerta("warning", "No se pudo acceder al sistema", data.mensaje);
                        }
                    })
                    .catch(error => {
                        document.getElementById("loginButton").disabled = false;
                        document.querySelector("#loginButton .spinner-border").classList.add("d-none");
                        mostrarAlerta("error", "Error al acceder al sistema", error);
                    });
            }
        }
    </script>
</body>

</html>
